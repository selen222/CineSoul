@model CineSoul.Models.Movie

@using Microsoft.AspNetCore.Identity
@using CineSoul.Models
@inject SignInManager<AppUser> SignInManager
@inject UserManager<AppUser> UserManager

@{
    ViewData["Title"] = Model.Title + " Detay";
    var trailerUrl = Model.TrailerUrl;
    var directorName = Model.Director;
    var genreDisplayNames = Model.Genres?.Select(g => g.Name).ToList() ?? new List<string>();

    var userLists = ViewBag.UserLists as List<UserList> ?? new List<UserList>();
    var isAlreadyInAnyList = userLists.Any(l => l.Items.Any(i => i.MovieId == Model.Id));
    var currentRating = ViewBag.UserRating as int?;
}

<style>
    .movie-header {
        position: relative;
        min-height: 70vh;
        padding-top: 5rem;
    }

    .detail-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: linear-gradient(to top, rgba(0,0,0,1) 0%, rgba(0,0,0,0.7) 30%, rgba(0,0,0,0.9) 100%);
        z-index: 1;
    }

    .detail-content {
        position: relative;
        z-index: 2;
    }

    .poster-img {
        max-height: 450px;
        width: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }

        .poster-img:hover {
            transform: scale(1.02);
        }

    .rating-badge {
        background: #ffc107;
        color: #000;
        padding: 5px 15px;
        border-radius: 20px;
        font-weight: bold;
    }
</style>

<div class="container-fluid text-white movie-header" style="background-image: url('@Model.FullBackdropUrl'); background-size: cover; background-position: center;">
    <div class="detail-overlay"></div>
    <div class="container detail-content py-5">
        <div class="row align-items-start">
            <div class="col-md-4 col-lg-3 text-center mb-4">
                <img src="@Model.FullPosterUrl" class="img-fluid rounded shadow-lg border border-secondary poster-img" alt="@Model.Title">

                @if (!string.IsNullOrEmpty(trailerUrl))
                {
                    <button type="button" class="btn btn-danger btn-lg w-100 mt-3 shadow" data-bs-toggle="modal" data-bs-target="#trailerModal">
                        <i class="fas fa-play me-2"></i> Fragmanı İzle
                    </button>
                }

                <div class="mt-3">
                    @if (SignInManager.IsSignedIn(User))
                    {
                        <button id="mainToggleButton" class="btn @(isAlreadyInAnyList ? "btn-success" : "btn-outline-primary") btn-lg w-100 shadow" onclick="handleToggleList(@Model.Id)">
                            <i class="fas @(isAlreadyInAnyList ? "fa-check-circle" : "fa-plus-circle") me-2"></i>
                            <span id="btnText">@(isAlreadyInAnyList ? "Listemde" : "Listeme Ekle")</span>
                        </button>
                    }
                    else
                    {
                        @if (!User.Identity.IsAuthenticated)
                        {
                            <a asp-controller="Account" asp-action="Login"
                               asp-route-returnUrl="@Context.Request.Path"
                               class="btn btn-primary btn-lg">
                                Giriş Yap & Listeye Ekle
                            </a>
                        }
                    }
                </div>

                @if (SignInManager.IsSignedIn(User))
                {
                    <div class="mt-4 p-3 bg-dark bg-opacity-75 rounded border border-secondary text-start">
                        <h6 class="text-white mb-3"><i class="fas fa-star text-warning me-2"></i>Bu Filme Puan Ver</h6>
                        @if (currentRating.HasValue)
                        {
                            <p class="small text-info mb-2">Mevcut Puanınız: <span class="badge bg-info text-dark">@currentRating / 10</span></p>
                        }
                        <form asp-controller="Movies" asp-action="RateMovie" method="post" class="d-flex gap-2">
                            <input type="hidden" name="movieId" value="@Model.Id" />
                            <select name="rating" class="form-select form-select-sm bg-secondary text-white border-0">
                                @for (int i = 10; i >= 1; i--)
                                {
                                    <option value="@i" selected="@(currentRating == i)">@i</option>
                                }
                            </select>
                            <button type="submit" class="btn btn-sm btn-warning">Puanla</button>
                        </form>
                    </div>
                }
            </div>

            <div class="col-md-8 col-lg-9 pt-md-5">
                <h1 class="display-4 fw-bold">@Model.Title (@Model.Year)</h1>
                <p class="lead text-warning fw-italic">@Model.Tagline</p>

                <div class="d-flex align-items-center mb-3">
                    <span class="badge bg-warning text-dark me-3 fs-5">@Model.VoteAverage.ToString("F1") ⭐</span>
                    <span class="text-muted fs-6 me-3"><i class="far fa-clock me-1"></i> @Model.Runtime dk</span>
                </div>

                <p class="mb-4"><strong>Türler:</strong> @string.Join(", ", genreDisplayNames)</p>
                <hr class="text-secondary opacity-25">
                <h3 class="mb-2">Konu Özeti</h3>
                <p class="fs-6 lh-lg">@Model.Overview</p>

                <div class="row mt-4">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Yönetmen:</strong> <span class="text-info">@(directorName ?? "Bilinmiyor")</span></p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-1"><strong>Oyuncular:</strong> <span class="text-info">@(Model.Cast ?? "Bilinmiyor")</span></p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@if (!string.IsNullOrEmpty(trailerUrl))
{
    <div class="modal fade" id="trailerModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content bg-dark border-secondary">
                <div class="modal-header border-0">
                    <h5 class="modal-title text-white">@Model.Title - Fragman</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="ratio ratio-16x9">
                        <iframe id="trailerIframe" src="@trailerUrl" title="YouTube trailer" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
}

@section Scripts {
    <script>
        function handleToggleList(movieId) {
            const btn = document.getElementById('mainToggleButton');
            const btnText = document.getElementById('btnText');
            btn.disabled = true;
            btnText.innerText = "İşleniyor...";
            const formData = new URLSearchParams();
            formData.append('movieId', movieId);

            fetch('/Movies/AddToList', {
                method: 'POST',
                body: formData,
                headers: { 'RequestVerificationToken': document.querySelector('input[name="__RequestVerificationToken"]')?.value }
            })
            .then(response => {
                if (response.redirected) { window.location.href = response.url; }
                else { location.reload(); }
            })
            .catch(error => { console.error('Hata:', error); btn.disabled = false; });
        }
    </script>
}